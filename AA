# bot.py - Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø°ÙƒÙŠ
# Ø§Ù„ØªØ­Ø¯ÙŠØ«: ÙƒÙ„ 3 Ø¥Ø´Ø§Ø±Ø§Øª â†’ ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø­Ø¯ Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù†Ù…Ø·

try:
    import telethonpatch
except Exception:
    pass

import os
import json
import asyncio
import logging
import random
import time
import tempfile
import requests
from io import BytesIO
from datetime import datetime
import pytz
from typing import List, Optional, Dict, Union, Any
from telethon import TelegramClient, events, Button
from telethon.errors import FloodWaitError
from telethon.tl.functions.messages import HideAllChatJoinRequestsRequest
from telethon.tl.types import UpdatePendingJoinRequests

# ---------------- logging ----------------
logging.basicConfig(level=logging.INFO, format="%(asctime)s | %(levelname)s | %(message)s")
log = logging.getLogger("bot")

# ---------------- Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø¨ÙŠØ¦Ø© ----------------
try:
    from config import API_ID, API_HASH, PHONE, PASSWORD, BOT_TOKEN, CHANNEL_IDENTIFIER, ADMIN_ID
except ImportError:
    API_ID = int(os.getenv("TELEGRAM_API_ID", "0"))
    API_HASH = os.getenv("TELEGRAM_API_HASH", "")
    PHONE = os.getenv("TELEGRAM_PHONE", "")
    PASSWORD = os.getenv("TELEGRAM_PASSWORD", "")
    BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN", "")
    CHANNEL_IDENTIFIER = os.getenv("TELEGRAM_CHANNEL", "")
    ADMIN_ID = int(os.getenv("TELEGRAM_ADMIN_ID", "0")) if os.getenv("TELEGRAM_ADMIN_ID") else 0

TIMEZONE = pytz.timezone('Africa/Cairo')

if not API_ID or not API_HASH:
    log.critical("Missing TELEGRAM_API_ID or TELEGRAM_API_HASH in environment.")
    raise SystemExit("Set TELEGRAM_API_ID and TELEGRAM_API_HASH first.")

if not PHONE:
    log.critical("Missing TELEGRAM_PHONE in environment.")
    raise SystemExit("Set TELEGRAM_PHONE first.")

# ---------------- resources & state ----------------
APPLE_GAME_PHOTOS = ["apple1.jpg", "apple2.jpg", "apple3.jpg"]
PLAN_ONE_IMAGES = ["https://i.ibb.co/rfZ91BK2/6.jpg", "https://i.ibb.co/Ng2CHCgm/7.jpg"]
PLAN_TWO_IMAGES = ["https://i.ibb.co/whfSdLCX/8.jpg", "https://i.ibb.co/wFgCkrxp/9.jpg"]
PLAN_THREE_IMAGE = "https://i.ibb.co/hxDKTCwY/10.jpg"

# ============ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ ============
VIDEOS_DIR = "videos"
VIDEO_EVERY_N_SIGNALS = 3  # ÙÙŠØ¯ÙŠÙˆ ÙƒÙ„ 3 Ø¥Ø´Ø§Ø±Ø§Øª
VIDEO_CAPTION = """ðŸŽ¯ Ø´ÙˆÙ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ¹Ù„ÙŠØ© Ù„Ù„Ø¥Ø´Ø§Ø±Ø©!

âœ… ØªÙ… Ø§Ù„ÙÙˆØ² Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
ðŸ’° Ø§Ù„Ø±Ø¨Ø­ Ù…Ø¶Ù…ÙˆÙ† Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©

âš ï¸ ØªØ°ÙƒØ±: Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆØ¯ BB33 Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
ðŸ”— Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„: https://redirspinner.com/2CFD?p=%2Fregistration%2F
ðŸ’¬ Ù„Ù„ØªÙˆØ§ØµÙ„: @elharam110"""

# Ø±Ø¨Ø· Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø¨Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
PATTERN_TO_VIDEO = {
    # ØµÙ ÙˆØ§Ø­Ø¯
    "9:0": "proof_row9_col0.mp4",
    "9:1": "proof_row9_col1.mp4",
    "9:2": "proof_row9_col2.mp4",
    "9:3": "proof_row9_col3.mp4",
    "9:4": "proof_row9_col4.mp4",
    
    # ØµÙÙŠÙ†
    "9:0_8:0": "proof_row9_0_row8_0.mp4",
    "9:0_8:2": "proof_row9_0_row8_2.mp4",
    "9:1_8:3": "proof_row9_1_row8_3.mp4",
    "9:2_8:2": "proof_row9_2_row8_2.mp4",
    "9:4_8:4": "proof_row9_4_row8_4.mp4",
    "9:0_8:4": "proof_row9_0_row8_4.mp4",
    "9:4_8:0": "proof_row9_4_row8_0.mp4",
    
    # Ø«Ù„Ø§Ø« ØµÙÙˆÙ
    "9:0_8:1_7:2": "proof_row9_0_row8_1_row7_2.mp4",
    "9:2_8:2_7:2": "proof_row9_2_row8_2_row7_2.mp4",
    "9:0_8:2_7:4": "proof_row9_0_row8_2_row7_4.mp4",
    "9:4_8:2_7:0": "proof_row9_4_row8_2_row7_0.mp4",
    "9:1_8:1_7:1": "proof_row9_1_row8_1_row7_1.mp4",
    
    # Ø£Ø±Ø¨Ø¹ ØµÙÙˆÙ
    "9:0_8:1_7:2_6:3": "proof_row9_0_row8_1_row7_2_row6_3.mp4",
    "9:3_8:2_7:1_6:0": "proof_row9_3_row8_2_row7_1_row6_0.mp4",
    "9:2_8:2_7:2_6:2": "proof_row9_2_row8_2_row7_2_row6_2.mp4",
    "9:0_8:4_7:0_6:4": "proof_row9_0_row8_4_row7_0_row6_4.mp4",
    "9:1_8:3_7:1_6:3": "proof_row9_1_row8_3_row7_1_row6_3.mp4",
}

# Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…ØªØ§Ø­Ø©
ALL_PATTERNS = [
    {9: 0}, {9: 1}, {9: 2}, {9: 3}, {9: 4},
    {9: 0, 8: 0}, {9: 0, 8: 2}, {9: 1, 8: 3}, {9: 2, 8: 2}, {9: 4, 8: 4}, {9: 0, 8: 4}, {9: 4, 8: 0},
    {9: 0, 8: 1, 7: 2}, {9: 2, 8: 2, 7: 2}, {9: 0, 8: 2, 7: 4}, {9: 4, 8: 2, 7: 0}, {9: 1, 8: 1, 7: 1},
    {9: 0, 8: 1, 7: 2, 6: 3}, {9: 3, 8: 2, 7: 1, 6: 0}, {9: 2, 8: 2, 7: 2, 6: 2}, 
    {9: 0, 8: 4, 7: 0, 6: 4}, {9: 1, 8: 3, 7: 1, 6: 3}
]

STATE_FILE = "state.json"
DELAY_BETWEEN_MESSAGES = 3
last_apple_patterns = []
last_used_patterns = []  # Ø¬Ø¯ÙŠØ¯: ØªØªØ¨Ø¹ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©
video_counter = 0  # Ø¬Ø¯ÙŠØ¯: Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª
last_apple_info = None  # Ø¬Ø¯ÙŠØ¯: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¢Ø®Ø± Ø¥Ø´Ø§Ø±Ø©

# Ø±ÙˆØ§Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠØ©
REGISTRATION_LINK = "https://redirspinner.com/2CFD?p=%2Fregistration%2F"
CONTACT_USERNAME = "@elharam110"
TUTORIAL_LINK = "https://t.me/c/3296506024/4287"

# ---------------- Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ ----------------
WELCOME_MSG = "Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ðŸ‘‹\nØ¬Ø§Ù‡Ø² ØªØ¨Ø¯Ø£ ØªØ´ØªØºÙ„ Ù…Ø¹Ø§Ù†Ø§ ÙˆØªØ¹Ù…Ù„ ÙÙ„ÙˆØ³ØŸ ðŸ’°"
SECOND_MSG = (
    "ÙƒÙ„ ÙŠÙˆÙ… Ø¨Ù†Ø²Ù„ Ø¥Ø´Ø§Ø±Ø§Øª Ù„Ù„Ø¹Ø¨Ø© ðŸŽApple Of FortuneðŸŽ Ø§Ù„Ù„ÙŠ Ø¨ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ù†Ø§Ø³ ÙŠÙƒØ³Ø¨ÙˆØ§ Ø¨Ø´ÙƒÙ„ "
    "Ø«Ø§Ø¨Øª Ø£ÙƒØªØ± Ù…Ù† 5000 Ø¬Ù†ÙŠÙ‡ ÙÙŠ Ø§Ù„ÙŠÙˆÙ…. Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø¨Ø³ÙŠØ· Ø¬Ø¯Ù‹Ø§: Ø£Ù†Ø§ Ø¨Ù‚ÙˆÙ„Ùƒ ØªØ±Ø§Ù‡Ù† ÙÙŠÙ†ØŒ "
    "Ø¥Ù†Øª Ø¨ØªÙƒØ±Ø±ØŒ ÙˆØ¥Ù†Øª Ø¨ØªÙƒØ³Ø¨."
)
THIRD_MSG = """Ø¨Øµ Ø¹Ù„Ù‰ Ù†ØªØ§ÙŠØ¬ Ø¹Ù…Ù„Ø§Ø¦ÙŠ ðŸ‘†
Ø§Ù„Ù†Ø§Ø³ Ø¯ÙŠ Ø¹Ù…Ø±Ù‡Ø§ Ù…Ø§ Ø³Ù…Ø¹Øª Ø¹Ù† Ù„Ø¹Ø¨Ø© ðŸŽApple Of FortuneðŸŽ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ ÙˆÙ…Ø§ÙƒØ§Ù†ÙˆØ´ ÙŠØ¹Ø±ÙÙˆØ§ Ø¥Ù† Ù…Ù…ÙƒÙ† ÙŠÙƒØ³Ø¨ÙˆØ§ Ù…Ù†Ù‡Ø§.
Ø¯Ù„ÙˆÙ‚ØªÙŠØŒ Ø¨ÙØ¶Ù„ Ø¥Ø´Ø§Ø±Ø§ØªÙŠØŒ Ø¨ÙŠÙƒØ³Ø¨ÙˆØ§ 5000 Ø¬Ù†ÙŠÙ‡ ÙÙŠ Ø§Ù„ÙŠÙˆÙ… ðŸ’¸
"""
FOURTH_MSG = """Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø³Ù‡Ù„Ø© âœ…

ÙÙŠ Ø§Ù„Ø£ÙˆÙ„ Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù‘Ù„ ÙÙŠ Spinbetter Ø¨Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù„Ø¨Ø±ÙˆÙ…Ùˆ ÙƒÙˆØ¯ Ø§Ùˆ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨ÙŠÙ†Ø§:   BB33
Ù…Ù„Ø­ÙˆØ¸Ù‡ : Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙŠØ´Ø¨Ù‡ 1Xbet Ø¨Ù†Ø³Ø¨Ù‡ 100%

Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„ : ðŸ”¥ðŸ”¥ https://redirspinner.com/2CFD?p=%2Fregistration%2F

Ø±Ø§Ø¨Ø· ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ : https://spin-b.com/mwGY27?tag=d_198425m_625309c_cz_Rp1izZ7MNLjqkWLbUKTekx

Ø¨Ø¹Ø¯Ù‡Ø§ Ø¨ØªØ­Ø· Ø¥ÙŠØ¯Ø§Ø¹ 195 Ø¬Ù†ÙŠÙ‡ Ø§Ùˆ Ø§ÙƒØªØ±ØŒ ÙˆØ¨Ø¹Ø¯Ù‡Ø§ Ø¨ØªØ³ØªØ¹Ù…Ù„ Ø¥Ø´Ø§Ø±Ø§ØªÙŠ Ø§Ù„Ù€ VIP Ø¹Ø´Ø§Ù† ØªÙƒØ³Ø¨!

ðŸš€ ØªØ§Ø¨Ø¹ Ù‚Ù†Ø§ØªÙŠ ÙˆØ´ÙˆÙ Ø¨Ù†ÙØ³Ùƒ! ðŸ‘‡
https://t.me/+0rHjbBJAvV0xMmVk

Ù†ØµÙŠØ¨ÙŠ Ù‡Ùˆ 10% Ù…Ù† Ø£Ø±Ø¨Ø§Ø­Ùƒ ÙÙŠ Ø§Ù„Ø´Ù‡Ø±!
Ø®Ù„ÙŠÙ†Ø§ Ù†ÙƒÙˆÙ† ØµØ±ÙŠØ­ÙŠÙ† Ù…Ø¹ Ø¨Ø¹Ø¶ ðŸ¤ðŸ˜‰

Ø§ÙˆÙ„ Ù…Ø§ ØªØ¹Ù…Ù„ Ø§Ø±Ø¨Ø§Ø­ ØµÙˆØ±Ù‡Ø§Ù„ÙŠ Ùˆ Ø§Ø¨Ø¹ØªÙ‡Ø§ Ù‡Ù†Ø§ Ù†Ø´Ø§Ø±Ùƒ Ø¨ÙŠÙ‡Ø§ Ø§Ù„Ù†Ø§Ø³ Ù…Ø¹ Ø¨Ø¹Ø¶ â¤ï¸
ÙƒÙ„Ù…Ù†ÙŠ Ø¹Ù„ÙŠ : @elharam110
"""
PLAN_ONE_TEXT = """
âœ¨ Ù…Ø´ Ø¨Ø³ ÙØ®ÙˆØ± Ø¨Ø§Ù„Ù„ÙŠ Ø¨Ø¹Ù…Ù„Ù‡â€¦ ÙƒÙ…Ø§Ù† Ø³Ø¹ÙŠØ¯ Ø¥Ù†ÙŠ Ø¨Ø´ÙˆÙ Ø­ÙŠØ§Ø© Ù†Ø§Ø³ ÙƒØªÙŠØ± Ø¨ØªØªØºÙŠØ± Ø¨ÙØ¶Ù„ Ù…Ø¬Ù‡ÙˆØ¯ÙŠ ðŸ’¸
Ø£Ù‡Ù… Ø­Ø§Ø¬Ø© Ø¹Ù†Ø¯ÙŠ Ø£Ø´ÙˆÙÙƒ Ù…Ø·Ù…Ù‘Ù†ØŒ ÙˆØ§Ø«Ù‚ØŒ ÙˆØ¹Ø§ÙŠØ´ Ø£Ø­Ø³Ù†.

ÙØ±ÙŠÙ‚ÙŠ Ø­Ù„Ù‘Ù„ Ø£Ù„Ø¹Ø§Ø¨ Ø²ÙŠ Ø§Ù„ØªÙØ§Ø­Ù‡ Ùˆ Ø§Ù„Ø·ÙŠØ§Ø±Ù‡ ÙˆPenalty.
ÙˆÙ…Ù† Ù‡Ù†Ø§ Ø·Ù„Ø¹ Ø¨Ø±Ù†Ø§Ù…Ø¬ Ù‚ÙˆÙŠ Ø¨ÙŠØªÙˆÙ‚Ø¹ Ø¨Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ© ðŸ’»

Ù…Ø´ Ø¨ÙˆØ¹Ø¯Ùƒ ØªØ¹Ù…Ù„ Ù…Ù„Ø§ÙŠÙŠÙ† Ø¨ÙŠÙ† ÙŠÙˆÙ… ÙˆÙ„ÙŠÙ„Ø© ÙŠØ§ Ø£Ø®ÙˆÙŠØ§â€¦ Ù„ÙƒÙ† Ù„Ùˆ Ø§ØªØ¨Ø¹Øª Ø®Ø·ÙˆØªÙŠØŒ Ù…Ù…ÙƒÙ† ØªÙƒØ³Ø¨ Ø¨Ø³Ù‡ÙˆÙ„Ø© Ù…Ù† Ù¨Ù Ù Ù  Ù„Ù€Ù¡Ù Ù Ù Ù  Ø¬Ù†ÙŠÙ‡ ÙŠÙˆÙ…ÙŠÙ‹Ø§ ðŸ¤—

ÙˆØ§Ù„Ø£Ø­Ù„Ù‰: Ø¨Ù€Ù¢Ù¥Ù  Ø¬Ù†ÙŠÙ‡ Ø¨Ø³ØŒ Ù…Ù…ÙƒÙ† ØªØ­ÙˆÙ„Ù‡Ù… Ù„Ø£ÙƒØªØ± Ù…Ù† Ù¨Ù Ù Ù  Ø¬Ù†ÙŠÙ‡ ÙÙŠ Ø³Ø§Ø¹ØªÙŠÙ† ðŸ¤‘

ðŸš€ Ø§Ù„ÙØ±ØµØ© Ø¯ÙŠ Ù…Ø´ Ù‡ØªØ±Ø¬Ø¹â€¦ Ø®Ø¯ Ø®Ø·ÙˆØ© Ø§Ù„Ù†Ù‡Ø§Ø±Ø¯Ø© ÙˆØ§Ù†Ø¶Ù… Ù„ÙØ±ÙŠÙ‚ÙŠ.

Ù„Ù„ØªÙˆØ§ØµÙ„ : â¬‡ï¸â¬‡ï¸
ðŸ‘‰ @elharam110
ðŸ‘‰ @elharam110
ðŸ‘‰ @elharam110
"""
PLAN_TWO_TEXT = """
ðŸ’Ž ÙƒÙ„ ÙŠÙˆÙ… Ø¨ÙŠÙˆØµÙ„Ù†ÙŠ Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ù†Ø§Ø³ Ø­ÙŠØ§ØªÙ‡Ù… Ø¨Ø¯Ø£Øª ØªØªØºÙŠØ± Ø¨ÙØ¶Ù„ Ø§Ù„Ø¨ÙˆØª:

ðŸ’¬ "ÙŠØ§ Ø£Ø®ÙˆÙŠØ§ØŒ Ø§Ù…Ø¨Ø§Ø±Ø­ Ø³Ø­Ø¨Øª Ù¨Ù Ù Ù  Ø¬Ù†ÙŠÙ‡ Ù…Ù† ØºÙŠØ± Ø£ÙŠ Ù…Ø¬Ù‡ÙˆØ¯. Ø­Ø§Ø¬Ø© Ø®ÙŠØ§Ù„ÙŠØ©!"
ðŸ’¬ "Ø¹Ù…Ø±ÙŠ Ù…Ø§ ÙƒÙ†Øª Ø£ØªØ®ÙŠÙ„ ÙŠÙƒÙˆÙ† Ø¹Ù†Ø¯ÙŠ Ø¯Ø®Ù„ Ø²ÙŠØ§Ø¯Ø© ÙƒØ¯Ù‡ØŒ Ø¯Ù„ÙˆÙ‚ØªÙŠ Ø¨Ù‚Ù‰ Ø¹Ø§Ø¯Ø© ÙƒÙ„ Ø£Ø³Ø¨ÙˆØ¹."
ðŸ’¬ "Ø¨ÙØ¶Ù„ Ø§Ù„Ø¨ÙˆØª Ù…Ø§ Ø¨Ù‚ÙŠØªØ´ Ù…Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù…Ø±ØªØ¨ÙŠ Ø¨Ø³ØŒ Ø¯Ù‡ Ù…Ø³ØªÙˆÙ‰ ØªØ§Ù†ÙŠ Ø®Ø§Ù„Øµ!"

âš¡ï¸ Ù†Ø§Ø³ Ø¹Ø§Ø¯ÙŠØ© Ø²ÙŠÙƒ Ø¨Ø§Ù„Ø¸Ø¨Ø·ØŒ Ù„ÙƒÙ† Ø¹Ù†Ø¯Ù‡Ù… Ø§Ù„Ø¬Ø±Ø£Ø© ÙŠØ§Ø®Ø¯ÙˆØ§ Ø®Ø·ÙˆØ©.

â“ Ø¹Ø§ÙŠØ² Ù‚ØµØªÙƒ ØªÙƒÙˆÙ† Ø§Ù„Ø¬Ø§ÙŠØ© Ø§Ù„Ù„ÙŠ Ù†Ù†Ø´Ø±Ù‡Ø§ ÙÙŠ Ø§Ù„Ù‚Ù†Ø§Ø©ØŸ

ðŸ“© Ø§Ø¨Ø¹ØªÙ„ÙŠ Ø¯Ù„ÙˆÙ‚ØªÙŠ: @elharam110
"""
PLAN_THREE_TEXT = """
ðŸ”¥ Ù…Ø´ Ø¨Ø¨ÙŠØ¹ ÙƒÙˆØ±Ø³Ø§Øª ÙˆÙ…Ø´ Ø¨ÙˆØ¹ÙØ¯ Ø¨Ù…Ø¹Ø¬Ø²Ø§Øª.

Ø£Ù†Ø§ Ø¨Ø³ Ø¨Ø´Ø§Ø±Ùƒ Ø§Ù„Ø­Ø§Ø¬Ø© Ø§Ù„Ù„ÙŠ ÙØ¹Ù„Ø§Ù‹ ØºÙŠÙ‘Ø±Øª Ø­ÙŠØ§ØªÙŠ.
ðŸ“ˆ Ø¨Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¯Ù‡ Ø¨Ø¯Ø£Øª Ø£ÙƒØ³Ø¨ Ø¨Ø´ÙƒÙ„ Ø¹Ù…Ø±ÙŠ Ù…Ø§ ÙƒÙ†Øª Ù…ØªØ®ÙŠÙ‘Ù„Ù‡.

â³ Ù‡ØªØ¬Ø±Ù‘Ø¨ ÙˆØªØ¯ÙŠ Ù„Ù†ÙØ³Ùƒ ÙØ±ØµØ©ØŸ ÙˆÙ„Ø§ Ù‡ØªÙØ¶Ù„ ØªØªÙØ±Ù‘Ø¬ ÙˆØ§Ù„Ù†Ø§Ø³ Ø­ÙˆØ§Ù„ÙŠÙƒ Ø¨ØªÙƒØ³Ø¨ØŸ

Ø§ÙƒØªØ¨Ù„ÙŠ Ø¯Ù„ÙˆÙ‚ØªÙŠ: ðŸ‘‰ðŸ’Ž @elharam110
"""
GAME_INTRO_TEXT = "ðŸš¨ðŸš¨ Ø§Ù†ØªØ¸Ø± Ø¥Ø´Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©..."
GAME_CONGRATS_TEXT = "ðŸŽ‰ Ù…Ø¨Ø±ÙˆÙƒ Ù„ÙƒÙ„ Ù…Ù† Ø´Ø§Ø±Ùƒ ÙˆÙØ§Ø² Ù…Ø¹Ù†Ø§! Ø§Ù†ØªØ¸Ø±ÙˆÙ†Ø§ ÙÙŠ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©..."
FINAL_SUPPORT_MSG = "Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù…Ø´ÙƒÙ„Ø© Ø§Ùˆ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª ØªÙˆØ§ØµÙ„ Ù…Ø¹ : @elharam110"

# Ø±Ø³Ø§Ø¦Ù„ FOMO ÙˆØ§Ù„Ù…ØªØ§Ø¨Ø¹Ø©
FOMO_30MIN_MSG = """â° ØªÙ†Ø¨ÙŠÙ‡ Ù…Ù‡Ù…!

Ù„Ø§Ø­Ø¸Øª Ø¥Ù†Ùƒ Ø´ÙØª Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù„ÙƒÙ† Ù„Ù… ØªØ³Ø¬Ù„ Ø¨Ø¹Ø¯.

âš ï¸ Ù…Ø¹Ù„ÙˆÙ…Ø©: Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠ BB33 Ù…ØªØ§Ø­ Ù„Ø£ÙˆÙ„ 50 Ø´Ø®Øµ ÙÙ‚Ø· ÙƒÙ„ ÙŠÙˆÙ…
ðŸ“Š Ø§Ù„ÙŠÙˆÙ… Ø³Ø¬Ù„ 37 Ø´Ø®Øµ... Ø¨Ø§Ù‚ÙŠ 13 Ù…ÙƒØ§Ù† ÙÙ‚Ø·!

ÙƒÙ„ Ø¯Ù‚ÙŠÙ‚Ø© ØªØªØ£Ø®Ø± ÙÙŠÙ‡Ø§ = Ø®Ø³Ø§Ø±Ø© ÙØ±ØµØ© Ø±Ø¨Ø­ Ù…Ø­ØªÙ…Ù„Ø© ðŸ’¸"""

FOMO_3HOURS_MSG = """ðŸš¨ ØªØ­Ø°ÙŠØ±!

Ø£Ù†Øª ÙÙŠ Ø·Ø±ÙŠÙ‚Ùƒ Ù„Ø®Ø³Ø§Ø±Ø© ÙØ±ØµØ© Ø§Ù„Ø¹Ù…Ø±...

ðŸ’° Ù„Ùˆ ÙƒÙ†Øª Ø³Ø¬Ù„Øª Ù…Ù† 3 Ø³Ø§Ø¹Ø§ØªØŒ ÙƒÙ†Øª Ø§Ù„Ø¢Ù† Ø±Ø¨Ø­Øª Ù…Ù† Ø¢Ø®Ø± 12 Ø¥Ø´Ø§Ø±Ø©
ðŸ“ˆ Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ù†Ø¬Ø­Øª Ø¨Ù†Ø³Ø¨Ø© 100% ÙˆÙƒØ³Ø¨Øª Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù…ØªÙˆØ³Ø· 3,200 Ø¬Ù†ÙŠÙ‡

â° Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ø§Ù„Ù‚Ø§Ø¯Ù…Ø© Ø®Ù„Ø§Ù„ 15 Ø¯Ù‚ÙŠÙ‚Ø©
âŒ Ø¨Ø¯ÙˆÙ† ØªØ³Ø¬ÙŠÙ„ = Ø¨Ø¯ÙˆÙ† Ø£Ø±Ø¨Ø§Ø­

Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø¢Ù†ØŸ"""

FOMO_24HOURS_MSG = """ðŸ“‰ Ø®Ø³Ø±Øª ÙØ¹Ù„ÙŠØ§Ù‹:

Ø¨Ø§Ù„Ø£Ù…Ø³ Ø£Ø±Ø³Ù„Ù†Ø§ 96 Ø¥Ø´Ø§Ø±Ø© Ø±Ø§Ø¨Ø­Ø© (ÙƒÙ„ 15 Ø¯Ù‚ÙŠÙ‚Ø©):
- Ù…ØªÙˆØ³Ø· Ø§Ù„Ø±Ø¨Ø­ Ù„ÙƒÙ„ Ø¥Ø´Ø§Ø±Ø©: +2,500 Ø¬Ù†ÙŠÙ‡
- Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© ÙÙŠ 24 Ø³Ø§Ø¹Ø©: 240,000 Ø¬Ù†ÙŠÙ‡
- Ø®Ø³Ø§Ø±ØªÙƒ Ø§Ù„Ø´Ø®ØµÙŠØ© Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø©: 12,000+ Ø¬Ù†ÙŠÙ‡

ðŸ’” ÙƒÙ… ÙŠÙˆÙ… Ø¢Ø®Ø± Ø³ØªØ®Ø³Ø± ÙÙŠÙ‡ Ù‡Ø°Ù‡ Ø§Ù„ÙØ±ØµØŸ

âš¡ Ø§Ù„ÙØ±ØµØ© Ø§Ù„Ø£Ø®ÙŠØ±Ø© - Ø³Ø¬Ù„ Ø§Ù„Ø¢Ù† ÙˆÙ„Ø§ ØªØ¶ÙŠØ¹ ÙŠÙˆÙ… Ø¢Ø®Ø±!"""

GUARANTEE_MSG = """ðŸŽ Ø¹Ø±Ø¶ Ø®Ø§Øµ Ù„Ùƒ!

Ø£Ø¹Ø±Ù Ø¥Ù†Ùƒ Ø®Ø§ÙŠÙ Ù…Ù† Ø§Ù„Ù…Ø®Ø§Ø·Ø±Ø©ØŒ Ø¹Ø§Ø¯ÙŠ Ø¬Ø¯Ø§Ù‹.

Ù„Ø°Ù„Ùƒ Ø£Ù‚Ø¯Ù…Ù„Ùƒ Ø¶Ù…Ø§Ù† Ø´Ø®ØµÙŠ Ù…Ù†ÙŠ:

âœ… Ø³Ø¬Ù„ ÙˆØ§Ø¯ÙØ¹ Ø§Ù„Ù€ 195 Ø¬Ù†ÙŠÙ‡
âœ… Ø¬Ø±Ø¨ Ø£ÙˆÙ„ 3 Ø¥Ø´Ø§Ø±Ø§Øª
âœ… Ù„Ùˆ Ù…Ø§ ÙƒØ³Ø¨ØªØ´ ÙÙŠ ÙˆØ§Ø­Ø¯Ø© Ù…Ù†Ù‡Ù…...
ðŸ’° Ø£Ù†Ø§ Ø´Ø®ØµÙŠØ§Ù‹ Ø£Ø±Ø¬Ø¹Ù„Ùƒ Ø§Ù„Ù€ 195 Ø¬Ù†ÙŠÙ‡ ÙƒØ§Ù…Ù„Ø©!

Ù„ÙŠÙ‡ Ø§Ù„Ø¶Ù…Ø§Ù† Ø¯Ù‡ØŸ 
Ù„Ø£Ù†ÙŠ ÙˆØ§Ø«Ù‚ 100% Ù…Ù† Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª ðŸŽ¯

â° Ø§Ù„Ø¹Ø±Ø¶ Ø¯Ù‡ ØµØ§Ù„Ø­ Ù„Ù€ 24 Ø³Ø§Ø¹Ø© ÙÙ‚Ø·
ðŸ’¬ Ø±Ø¯ Ø¨Ù€ "Ù…ÙˆØ§ÙÙ‚" Ø¹Ø´Ø§Ù† Ø£Ø¨Ø¯Ø£ Ù…Ø¹Ø§Ùƒ"""

# ---------------- clients and state ----------------
SESSION_USER = f"session_user_{PHONE.replace('+','').replace(' ','')}" if PHONE else "session_user"
SESSION_BOT = "session_bot"
user_client = TelegramClient(SESSION_USER, API_ID, API_HASH)
bot_client = TelegramClient(SESSION_BOT, API_ID, API_HASH) if BOT_TOKEN else None
bot_started = False
message_host = None
user_target_channel = None

state = {
    "users_welcomed": [], 
    "users_sent": [], 
    "users_final_replied": [], 
    "users_join_time": {}, 
    "users_registered": [],
    "video_counter": 0,  # Ø¬Ø¯ÙŠØ¯
    "last_used_patterns": []  # Ø¬Ø¯ÙŠØ¯
}
users_welcomed = set()
users_sent = set()
users_final_replied = set()
users_join_time: Dict[int, float] = {}
users_registered = set()
_user_locks: Dict[int, asyncio.Lock] = {}
_dialogs_cache = None
_dialogs_cache_updated_at = 0
_DIALOGS_CACHE_TTL = 3600
_recently_processed_joins: Dict[int, float] = {}
_JOIN_DEDUP_WINDOW = 60
_join_handler_lock = asyncio.Lock()
_is_processing_join_event = False
_broadcast_mode: Dict[int, bool] = {}
_follow_up_tasks: Dict[int, asyncio.Task] = {}

# ============ Ø¯ÙˆØ§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ============

def create_pattern_id(pattern: Dict[int, int]) -> str:
    """Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù‘Ù ÙØ±ÙŠØ¯ Ù„Ù„Ù†Ù…Ø·"""
    sorted_rows = sorted(pattern.keys(), reverse=True)
    parts = [f"{row}:{pattern[row]}" for row in sorted_rows]
    return "_".join(parts)

def pattern_dict_to_id(pattern: Dict[int, int]) -> str:
    """ØªØ­ÙˆÙŠÙ„ pattern dictionary Ø¥Ù„Ù‰ string ID"""
    return create_pattern_id(pattern)

def get_available_patterns_with_videos() -> List[Dict[int, int]]:
    """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ù‡Ø§ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª Ù…ÙˆØ¬ÙˆØ¯Ø© ÙØ¹Ù„ÙŠØ§Ù‹"""
    available = []
    for pattern in ALL_PATTERNS:
        pattern_id = create_pattern_id(pattern)
        if pattern_id in PATTERN_TO_VIDEO:
            video_path = os.path.join(VIDEOS_DIR, PATTERN_TO_VIDEO[pattern_id])
            if os.path.exists(video_path):
                available.append(pattern)
    return available

def select_smart_pattern() -> Dict[int, int]:
    """
    Ø§Ø®ØªÙŠØ§Ø± Ù†Ù…Ø· Ø°ÙƒÙŠ Ù…Ø¹ Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
    - ÙŠØ®ØªØ§Ø± Ù…Ù† Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ù‡Ø§ ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª
    - ÙŠØªØ¬Ù†Ø¨ Ø§Ù„Ø£Ù†Ù…Ø§Ø· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ù…Ø¤Ø®Ø±Ø§Ù‹
    """
    global last_used_patterns
    
    available = get_available_patterns_with_videos()
    
    if not available:
        log.warning("âš ï¸ No patterns with videos found! Using random pattern")
        return random.choice(ALL_PATTERNS)
    
    # ØªØ¬Ù†Ø¨ Ø¢Ø®Ø± 5 Ø£Ù†Ù…Ø§Ø· Ù…Ø³ØªØ®Ø¯Ù…Ø©
    if last_used_patterns:
        unused = [p for p in available if pattern_dict_to_id(p) not in last_used_patterns[-5:]]
        if unused:
            available = unused
    
    # Ø§Ø®ØªÙŠØ§Ø± Ù†Ù…Ø· Ø¹Ø´ÙˆØ§Ø¦ÙŠ
    selected = random.choice(available)
    pattern_id = pattern_dict_to_id(selected)
    
    # Ø­ÙØ¸ ÙÙŠ Ø§Ù„ØªØ§Ø±ÙŠØ®
    last_used_patterns.append(pattern_id)
    if len(last_used_patterns) > 10:
        last_used_patterns.pop(0)
    
    return selected

async def generate_apple_game_with_pattern(custom_pattern: Optional[Dict[int, int]] = None) -> Tuple[str, Dict]:
    """
    ØªÙˆÙ„ÙŠØ¯ Ø¥Ø´Ø§Ø±Ø© ØªÙØ§Ø­Ø© Ù…Ø¹ Ù†Ù…Ø· Ù…Ø­Ø¯Ø¯ Ø£Ùˆ Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø°ÙƒÙŠ
    
    Returns:
        (game_text, apple_info)
    """
    global last_apple_info
    
    rows, columns = 10, 5
    base_grid = [["ðŸŸ«" for _ in range(columns)] for _ in range(rows)]
    
    # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù†Ù…Ø·
    if custom_pattern:
        selected_pattern = custom_pattern
    else:
        selected_pattern = select_smart_pattern()
    
    # ÙˆØ¶Ø¹ Ø§Ù„ØªÙØ§Ø­ Ø­Ø³Ø¨ Ø§Ù„Ù†Ù…Ø·
    for row, col in selected_pattern.items():
        base_grid[row][col] = "ðŸŽ"
    
    # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù‘Ù Ø§Ù„Ù†Ù…Ø·
    pattern_id = create_pattern_id(selected_pattern)
    
    # Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¥Ø´Ø§Ø±Ø©
    last_apple_info = {
        "pattern": selected_pattern,
        "pattern_id": pattern_id,
        "num_rows": len(selected_pattern),
        "rows": sorted(selected_pattern.keys(), reverse=True),
        "columns": [selected_pattern[r] for r in sorted(selected_pattern.keys(), reverse=True)]
    }
    
    # ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ù†Øµ
    grid_text = "\n".join("".join(row) for row in base_grid)
    game_text = f"""âœ… Ø§Ø´Ø§Ø±Ù‡ Ø¬Ø¯ÙŠØ¯Ù‡ âœ…
Ø§Ù„Ø§Ø´Ø§Ø±Ù‡ Ù„Ù…Ø¯Ù‡ Ù¥ Ø¯Ù‚Ø§Ø¦Ù‚ â°
ðŸ Apple oF Fortune ðŸ

{grid_text}

â€¼ï¸Ø§Ù„Ø§Ø´Ø§Ø±Ù‡ ØªØ¹Ù…Ù„ ÙÙ‚Ø· Ù„Ù…Ù† Ø§Ø³ØªØ¹Ù…Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠ BB33 Ø¹Ù† Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯
â€¼ï¸Ø§Ù‚Ù„ Ø§ÙŠØ¯Ø§Ø¹ Ø¹Ø´Ø§Ù† Ø§Ù„Ø¥Ø´Ø§Ø±Ø§Øª ØªØ´ØªØºÙ„ Ù…Ø¹Ø§Ùƒ Ù‡Ùˆ  195 Ø¬Ù†ÙŠÙ‡ Ùˆ ÙÙŠ Ø­Ø§Ù„Ù‡ Ø§Ù„Ø§ÙŠØ¯Ø§Ø¹ Ø¨Ù…Ø¨Ù„Øº Ø§Ù‚Ù„ Ù…Ù† 195 Ù‡ØªØ®Ø³Ø± Ù„Ù„Ø§Ø³Ù
Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„ : ðŸ”¥ðŸ”¥ {REGISTRATION_LINK}

Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ù…Ø´ÙƒÙ„Ø© Ø§Ùˆ Ø§Ø³ØªÙØ³Ø§Ø±Ø§Øª ØªÙˆØ§ØµÙ„ Ù…Ø¹ : {CONTACT_USERNAME}"""
    
    log.info(f"ðŸŽ Generated pattern: {pattern_id}")
    
    return game_text, last_apple_info

def get_video_for_pattern(apple_info: Dict) -> Optional[str]:
    """
    Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù„Ù†Ù…Ø·
    
    Returns:
        Ù…Ø³Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø£Ùˆ None
    """
    try:
        pattern_id = apple_info["pattern_id"]
        
        if pattern_id not in PATTERN_TO_VIDEO:
            log.warning(f"âš ï¸ No video mapping for pattern: {pattern_id}")
            return None
        
        video_name = PATTERN_TO_VIDEO[pattern_id]
        video_path = os.path.join(VIDEOS_DIR, video_name)
        
        if not os.path.exists(video_path):
            log.error(f"âŒ Video file not found: {video_path}")
            return None
        
        log.info(f"âœ… Found video for pattern {pattern_id}: {video_name}")
        return video_path
        
    except Exception as e:
        log.error(f"âŒ Error getting video for pattern: {e}")
        return None

async def send_video_note(video_path: str, apple_info: Dict) -> bool:
    """
    Ø¥Ø±Ø³Ø§Ù„ ÙÙŠØ¯ÙŠÙˆ Ø¯Ø§Ø¦Ø±ÙŠ (Video Note) Ù„Ù„Ù‚Ù†Ø§Ø©
    
    Args:
        video_path: Ù…Ø³Ø§Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        apple_info: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ù…Ø·
    
    Returns:
        True Ø¥Ø°Ø§ Ù†Ø¬Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    """
    try:
        if not os.path.exists(video_path):
            log.error(f"âŒ Video file not found: {video_path}")
            return False
        
        log.info(f"ðŸ“¹ Sending video note: {os.path.basename(video_path)}")
        
        # Ø¥Ø±Ø³Ø§Ù„ ÙƒÙ€ Video Note (Ø¯Ø§Ø¦Ø±ÙŠ)
        await user_client.send_file(
            user_target_channel,
            video_path,
            caption=VIDEO_CAPTION,
            buttons=create_action_buttons(),
            video_note=True,  # â† Ù‡Ø°Ø§ ÙŠØ¬Ø¹Ù„Ù‡ Ø¯Ø§Ø¦Ø±ÙŠ!
            thumb=None
        )
        
        log.info(f"âœ… Video note sent successfully for pattern {apple_info['pattern_id']}")
        return True
        
    except FloodWaitError as fe:
        log.warning(f"âš ï¸ FloodWait sending video: wait {fe.seconds}s")
        await asyncio.sleep(fe.seconds + 1)
        return False
    except Exception as e:
        log.error(f"âŒ Error sending video note: {e}")
        return False

# ---------------- persistence ----------------
def load_state():
    global state, users_welcomed, users_sent, users_final_replied, users_join_time, users_registered
    global video_counter, last_used_patterns
    try:
        if os.path.isfile(STATE_FILE):
            with open(STATE_FILE, "r", encoding="utf-8") as f:
                state = json.load(f)
            users_welcomed = set(state.get("users_welcomed", []))
            users_sent = set(state.get("users_sent", []))
            users_final_replied = set(state.get("users_final_replied", []))
            users_join_time = {int(k): float(v) for k, v in state.get("users_join_time", {}).items()}
            users_registered = set(state.get("users_registered", []))
            video_counter = state.get("video_counter", 0)  # Ø¬Ø¯ÙŠØ¯
            last_used_patterns = state.get("last_used_patterns", [])  # Ø¬Ø¯ÙŠØ¯
            log.info(f"Loaded state: welcomed={len(users_welcomed)}, video_counter={video_counter}")
        else:
            log.info("No state file found; starting fresh.")
    except Exception as e:
        log.error(f"Failed loading state: {e}")
        state = {
            "users_welcomed": [], 
            "users_sent": [], 
            "users_final_replied": [], 
            "users_join_time": {}, 
            "users_registered": [],
            "video_counter": 0,
            "last_used_patterns": []
        }
        users_welcomed = set()
        users_sent = set()
        users_final_replied = set()
        users_join_time = {}
        users_registered = set()
        video_counter = 0
        last_used_patterns = []

def save_state():
    try:
        with open(STATE_FILE, "w", encoding="utf-8") as f:
            json.dump({
                "users_welcomed": list(users_welcomed), 
                "users_sent": list(users_sent),
                "users_final_replied": list(users_final_replied),
                "users_join_time": {str(k): v for k, v in users_join_time.items()},
                "users_registered": list(users_registered),
                "video_counter": video_counter,  # Ø¬Ø¯ÙŠØ¯
                "last_used_patterns": last_used_patterns  # Ø¬Ø¯ÙŠØ¯
            }, f, ensure_ascii=False, indent=2)
        log.debug("State saved.")
    except Exception as e:
        log.error(f"Failed saving state: {e}")

# ---------------- helpers ----------------
def get_user_lock(user_id: int) -> asyncio.Lock:
    if user_id not in _user_locks:
        _
